name: Build Windows Installer

on:
  # 手动触发：在 GitHub 仓库页面 Actions 标签里点 "Run workflow"
  workflow_dispatch:
  # 或者推送 tag 时自动触发（如 git tag v1.0.0 && git push --tags）
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-2019  # windows-2019 预装 VS2019 + Windows 10 SDK，node-gyp 能直接编译原生模块

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # ── 1. 安装根目录依赖
      # --no-optional 跳过 pinyin 的可选依赖 nodejieba（旧版 nan，与 Electron 29 V8 不兼容）
      # sqlite3 的 postinstall 会先尝试下载预编译包，失败后才从源码编译（此时 VS2019+SDK 已就绪）
      - name: 安装根目录依赖
        run: npm install --no-optional

      # ── 1.5 从 GitHub Secrets 生成 secrets.js ──
      # 在 GitHub 仓库 → Settings → Secrets and variables → Actions 中添加：
      #   ALIPAY_APP_ID        → 支付宝 AppID
      #   ALIPAY_PRIVATE_KEY   → RSA2 私钥（完整内容含头尾行）
      #   ALIPAY_PUBLIC_KEY    → 支付宝公钥（完整内容含头尾行）
      #   ALIPAY_SANDBOX       → true 或 false
      - name: 生成 secrets.js
        shell: bash
        run: |
          cat > server/src/config/secrets.js << 'SECRETS_EOF'
          const secrets = {
            alipay: {
              appId: "${{ secrets.ALIPAY_APP_ID }}",
              privateKey: `${{ secrets.ALIPAY_PRIVATE_KEY }}`,
              alipayPublicKey: `${{ secrets.ALIPAY_PUBLIC_KEY }}`,
              sandbox: ${{ secrets.ALIPAY_SANDBOX || 'false' }}
            }
          };
          export default secrets;
          SECRETS_EOF

      # ── 2. 打包服务端 → public/bundle.cjs ──
      - name: 安装服务端依赖
        run: cd server && npm install

      - name: 打包服务端
        run: cd server && npm run build

      # ── 3. 打包客户端 → client/dist ──
      - name: 安装客户端依赖
        run: cd client && npm install

      - name: 打包客户端
        run: cd client && npm run build:electron

      # ── 4. 重新编译 sqlite3（为 Windows/Electron 平台，传入 MSVS_VERSION 确保 gyp 找到工具链）──
      - name: 重新编译原生模块
        run: npx electron-builder install-app-deps
        env:
          MSVS_VERSION: "2019"
          npm_config_msvs_version: "2019"

      # ── 5. 用 electron-builder 生成 Windows 安装包 ──
      - name: 生成 Windows 安装包
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 6. 上传安装包到 Artifacts（可下载）──
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/*.exe
          retention-days: 30
